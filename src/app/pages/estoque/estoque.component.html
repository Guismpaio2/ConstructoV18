<div class="main-content-container">
  <div class="page-header">
    <h1>Gerenciamento de Estoque</h1>
    <button
      *ngIf="canAddEditDeleteRegisterBaixa"
      class="btn btn-primary"
      (click)="goToAddEstoqueItem()"
    >
      <i class="fas fa-plus"></i> Adicionar Item ao Estoque
    </button>
  </div>

  <div class="search-filter-bar mt-4">
    <div class="search-input">
      <i class="fas fa-search search-icon"></i>
      <input
        type="text"
        placeholder="Buscar por produto, lote, localização..."
        [(ngModel)]="searchTerm"
        (input)="triggerFilterAndSort()"
      />
    </div>

    <select
      [(ngModel)]="selectedProductFilter"
      (change)="triggerFilterAndSort()"
    >
      <option value="">Todos os Produtos</option>
      <option
        *ngFor="let productName of productNamesForFilter"
        [value]="productName"
      >
        {{ productName }}
      </option>
    </select>

    <select [(ngModel)]="selectedSort" (change)="triggerFilterAndSort()">
      <option value="nomeProduto_asc">Nome do Produto (A-Z)</option>
      <option value="nomeProduto_desc">Nome do Produto (Z-A)</option>
      <option value="lote_asc">Lote (A-Z)</option>
      <option value="lote_desc">Lote (Z-A)</option>
      <option value="quantidade_asc">Quantidade (Menor-Maior)</option>
      <option value="quantidade_desc">Quantidade (Maior-Menor)</option>
      <option value="validade_asc">Validade (Mais Próxima)</option>
      <option value="validade_desc">Validade (Mais Distante)</option>
    </select>
  </div>

  <div *ngIf="filteredEstoqueItems.length === 0" class="alert alert-info mt-4">
    Nenhum item em estoque encontrado.
  </div>

  <div *ngIf="filteredEstoqueItems.length > 0" class="estoque-grid mt-4">
    <div class="estoque-card" *ngFor="let item of filteredEstoqueItems">
      <h4>{{ item.nomeProduto }}</h4>
      <div class="item-details">
        <span><label>Lote:</label> {{ item.lote }}</span>
        <span><label>Quantidade:</label> {{ item.quantidade }}</span>
        <span *ngIf="item.dataValidade"
          ><label>Validade:</label>
          {{ formatTimestamp(item.dataValidade) }}</span
        >
        <span *ngIf="item.localizacao"
          ><label>Localização:</label> {{ item.localizacao }}</span
        >
      </div>
      <div class="item-dates">
        <small
          ><label>Entrada:</label>
          {{ formatTimestamp(item.dataEntrada) }}</small
        >
        <small *ngIf="item.dataUltimaEdicao"
          ><label>Última Edição:</label>
          {{ formatTimestamp(item.dataUltimaEdicao) }}</small
        >
        <small *ngIf="item.usuarioUltimaEdicaoNome"
          ><label>Por:</label> {{ item.usuarioUltimaEdicaoNome }}</small
        >
      </div>

      <div class="item-actions" *ngIf="canAddEditDeleteRegisterBaixa">
        <button
          class="btn btn-sm btn-outline-info"
          (click)="goToEditEstoqueItem(item.uid)"
        >
          <i class="fas fa-edit"></i> Editar
        </button>
        <button
          class="btn btn-sm btn-outline-warning"
          (click)="goToRegisterBaixa(item.uid)"
        >
          <i class="fas fa-minus-circle"></i> Registrar Baixa
        </button>
        <button
          class="btn btn-sm btn-outline-danger"
          (click)="onDeleteEstoqueItem(item.uid, item.nomeProduto, item.lote)"
        >
          <i class="fas fa-trash-alt"></i> Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<div class="main-content-container">
  <div class="page-header">
    <h1>Controle de Estoque</h1>
    <div class="header-actions">
      <button
        class="btn btn-primary"
        (click)="goToAddEstoqueItem()"
        *ngIf="canAddEditDeleteRegisterBaixa$ | async"
      >
        <i class="fas fa-plus"></i> Adicionar Item
      </button>
    </div>
  </div>

  <div class="filter-sort-section">
    <div class="search-input-group">
      <i class="fas fa-search search-icon"></i>
      <input
        type="text"
        placeholder="Pesquisar por nome, lote, localização ou SKU..."
        [(ngModel)]="searchTerm"
        (input)="triggerFilterAndSort()"
        class="form-control search-field"
      />
      <button
        *ngIf="searchTerm"
        class="btn btn-clear-search"
        (click)="clearSearch()"
        title="Limpar pesquisa"
      >
        <i class="fas fa-times-circle"></i>
      </button>
    </div>

    <div class="filter-group">
      <i class="fas fa-filter filter-icon"></i>
      <select
        [(ngModel)]="selectedTypeFilter"
        (change)="triggerFilterAndSort()"
        class="form-control filter-field"
      >
        <option value="">Filtrar por Tipo</option>
        <option *ngFor="let type of productTypesForFilter" [value]="type">
          {{ type }}
        </option>
      </select>
    </div>

    <div class="sort-group">
      <i class="fas fa-sort sort-icon"></i>
      <select
        [(ngModel)]="selectedSort"
        (change)="triggerFilterAndSort()"
        class="form-control sort-field"
      >
        <option value="nomeProduto_asc">Ordenar por Produto (A-Z)</option>
        <option value="nomeProduto_desc">Ordenar por Produto (Z-A)</option>
        <option value="lote_asc">Ordenar por Lote (Crescente)</option>
        <option value="lote_desc">Ordenar por Lote (Decrescente)</option>
        <option value="quantidade_asc">Ordenar por Quantidade (Menor)</option>
        <option value="quantidade_desc">Ordenar por Quantidade (Maior)</option>
        <option value="validade_asc">
          Ordenar por Validade (Mais Próximo)
        </option>
        <option value="validade_desc">
          Ordenar por Validade (Mais Distante)
        </option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Lote</th>
          <th>Quantidade</th>
          <th>Validade</th>
          <th>Localização</th>
          <th>Última Atualização</th>
          <th>Atualizado Por</th>
          <th *ngIf="canAddEditDeleteRegisterBaixa$ | async">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let item of filteredEstoque"
          [ngClass]="{
            'expired-row': isExpired(item),
            'near-expiry-row': isNearExpiry(item)
          }"
        >
          <td class="product-info-cell">
            <img
              *ngIf="item.imageUrl"
              [src]="item.imageUrl"
              alt="Imagem do Produto"
              class="product-image"
            />
            <img
              *ngIf="!item.imageUrl"
              src="assets/images/default-product.png"
              alt="Produto sem imagem"
              class="product-image"
            />
            <div class="product-name-sku">
              <span>{{ item.nomeProduto }}</span>
              <span class="sku-text" *ngIf="item.sku">SKU: {{ item.sku }}</span>
            </div>
          </td>
          <td>{{ item.lote }}</td>
          <td>{{ item.quantidade }} {{ item.unidadeMedida }}</td>
          <td>
            {{ formatTimestamp(item.dataValidade) }}
            <i
              *ngIf="isExpired(item)"
              class="fas fa-info-circle expired-icon"
              title="Vencido"
            ></i>
            <i
              *ngIf="isNearExpiry(item)"
              class="fas fa-exclamation-triangle near-expiry-icon"
              title="Próximo do vencimento"
            ></i>
          </td>
          <td>{{ item.localizacao || "N/A" }}</td>
          <td>{{ formatTimestamp(item.dataUltimaAtualizacao) }}</td>
          <td>{{ item.usuarioUltimaEdicaoNome || "N/A" }}</td>
          <td
            *ngIf="canAddEditDeleteRegisterBaixa$ | async"
            class="action-buttons-cell"
          >
            <button
              class="btn btn-icon btn-edit"
              (click)="goToEditEstoqueItem(item.uid)"
              title="Editar"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              class="btn btn-icon btn-baixa"
              (click)="goToRegisterBaixa(item.uid)"
              title="Registrar Baixa"
            >
              <i class="fas fa-minus-circle"></i>
            </button>
            <button
              class="btn btn-icon btn-delete"
              (click)="onDeleteEstoqueItem(item.uid!, item.nomeProduto!)"
              title="Excluir"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredEstoque.length === 0 && !isLoading">
          <td colspan="9" class="text-center">
            Nenhum item de estoque encontrado com os critérios de busca/filtro.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Carregando...</span>
    </div>
  </div>
</div>

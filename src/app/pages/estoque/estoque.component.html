<div class="main-content-container">
  <div class="page-header">
    <h1>Controle de Estoque</h1>
    <div class="header-actions">
      <button
        class="btn primary"
        (click)="goToAddEstoqueItem()"
        *ngIf="canAddEditDeleteRegisterBaixa$ | async"
      >
        <i class="fas fa-plus"></i> Adicionar Item
      </button>
    </div>
  </div>

  <div class="search-filter-bar">
    <div class="search-input">
      <input
        type="text"
        placeholder="Buscar por produto, lote, localização, SKU..."
        [(ngModel)]="searchTerm"
        (input)="triggerFilterAndSort()"
        class="form-control"
      />
      <i class="fas fa-search search-icon"></i>
    </div>

    <select
      [(ngModel)]="selectedTypeFilter"
      (change)="triggerFilterAndSort()"
      class="form-control"
    >
      <option value="">Todos os Tipos</option>
      <option *ngFor="let type of productTypesForFilter" [value]="type">
        {{ type }}
      </option>
    </select>

    <select
      [(ngModel)]="selectedSort"
      (change)="triggerFilterAndSort()"
      class="form-control"
    >
      <option value="nomeProduto_asc">Produto (A-Z)</option>
      <option value="nomeProduto_desc">Produto (Z-A)</option>
      <option value="lote_asc">Lote (Crescente)</option>
      <option value="lote_desc">Lote (Decrescente)</option>
      <option value="quantidade_asc">Quantidade (Menor para Maior)</option>
      <option value="quantidade_desc">Quantidade (Maior para Menor)</option>
      <option value="validade_asc">Validade (Mais Próximo)</option>
      <option value="validade_desc">Validade (Mais Distante)</option>
    </select>
  </div>

  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Lote</th>
          <th>Quantidade</th>
          <th>Validade</th>
          <th>Localização</th>
          <th>Última Atualização</th>
          <th>Atualizado Por</th>
          <th *ngIf="canAddEditDeleteRegisterBaixa$ | async">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let item of filteredEstoque"
          [ngClass]="{
            'expired-row': isExpired(item),
            'near-expiry-row': isNearExpiry(item)
          }"
        >
          <td class="product-info-cell">
            <img
              *ngIf="item.imageUrl"
              [src]="item.imageUrl"
              alt="Imagem do Produto"
              class="product-image"
            />
            <img
              *ngIf="!item.imageUrl"
              src="assets/images/default-product.png"
              alt="Produto sem imagem"
              class="product-image"
            />
            {{ item.nomeProduto }}
          </td>
          <td>{{ item.lote }}</td>
          <td>{{ item.quantidade }}</td>
          <td>
            {{ formatTimestamp(item.dataValidade) }}
            <i
              *ngIf="isExpired(item)"
              class="fas fa-info-circle expired-icon"
              title="Vencido"
            ></i>
            <i
              *ngIf="isNearExpiry(item)"
              class="fas fa-exclamation-triangle near-expiry-icon"
              title="Próximo do vencimento"
            ></i>
          </td>
          <td>{{ item.localizacao || "N/A" }}</td>
          <td>{{ formatTimestamp(item.dataUltimaAtualizacao) }}</td>
          <td>{{ item.usuarioUltimaEdicaoNome || "N/A" }}</td>
          <td
            *ngIf="canAddEditDeleteRegisterBaixa$ | async"
            class="text-center"
          >
            <button
              class="btn info small"
              (click)="goToEditEstoqueItem(item.uid)"
              title="Editar"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              class="btn secondary small ms-2"
              (click)="goToRegisterBaixa(item.uid)"
              title="Registrar Baixa"
            >
              <i class="fas fa-minus-circle"></i>
            </button>
            <button
              class="btn danger small ms-2"
              (click)="onDeleteEstoqueItem(item.uid!, item.nomeProduto!)"
              title="Excluir"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredEstoque.length === 0 && !isLoading">
          <td colspan="9" class="text-center">
            Nenhum item de estoque encontrado com os critérios de busca/filtro.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Carregando...</span>
    </div>
  </div>
</div>
